apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  name: gaming
spec:
  template:
    spec:
      nodeClassRef:
        group: eks.amazonaws.com
        kind: NodeClass
        name: default
      requirements:
        # ARM64 (Graviton) preferred for cost savings, x86_64 as fallback
        - key: kubernetes.io/arch
          operator: In
          values: ["arm64", "amd64"]
        # Instance types suitable for gaming
        - key: node.kubernetes.io/instance-type
          operator: In
          values:
            # Graviton (ARM64) - ~20% cheaper, recommended
            - m7g.xlarge    # 4 vCPU, 16GB - ~1-2 sessions
            - m7g.2xlarge   # 8 vCPU, 32GB - ~3-4 sessions
            - m6g.xlarge    # 4 vCPU, 16GB - ~1-2 sessions
            - m6g.2xlarge   # 8 vCPU, 32GB - ~3-4 sessions
            # Intel/AMD (x86_64) - fallback
            - m6i.xlarge    # 4 vCPU, 16GB - ~1-2 sessions
            - m6i.2xlarge   # 8 vCPU, 32GB - ~3-4 sessions
            - m6a.xlarge    # 4 vCPU, 16GB (AMD)
            - m6a.2xlarge   # 8 vCPU, 32GB (AMD)
        # Use on-demand for reliability (change to spot for cost savings)
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["on-demand"]
  # Maximum cluster size
  limits:
    cpu: "100"      # Max 100 vCPUs
    memory: "400Gi" # Max 400GB RAM
  # Consolidation settings - scale down unused nodes
  disruption:
    consolidationPolicy: WhenEmptyOrUnderutilized
    consolidateAfter: 60s
