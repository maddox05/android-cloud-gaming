services:
  redroid:
    image: ${REDROID_IMAGE}:${REDROID_TAG}
    privileged: true
    volumes:
      - redroid-base:/data-base:ro   # Shared golden image (read-only)
    tmpfs:
      - /data-diff:size=2G           # Ephemeral diff in RAM (auto-deleted on stop)
    command:
      - androidboot.use_redroid_overlayfs=1
      - androidboot.redroid_overlayfs_lower=/data-base
      - androidboot.redroid_overlayfs_upper=/data-diff
      - androidboot.redroid_width=${REDROID_WIDTH}
      - androidboot.redroid_height=${REDROID_HEIGHT}
      - androidboot.redroid_dpi=${REDROID_DPI}
      - androidboot.redroid_fps=${REDROID_FPS}
    networks:
      - internal   # Only on internal network (isolated per pod)

  worker:
    build: ./worker
    restart: always
    environment:
      SIGNAL_URL: ws://signal:${SIGNAL_PORT}
      REDROID_HOST: redroid
      REDROID_WIDTH: ${REDROID_WIDTH}
      REDROID_HEIGHT: ${REDROID_HEIGHT}
    depends_on:
      - redroid
    networks:
      - cloud-gaming   # For signal server communication
      - internal       # For redroid communication (isolated per pod)

volumes:
  redroid-base:
    external: true
    name: redroid-base   # Shared golden image (create once, use by all pods)

networks:
  cloud-gaming:
    external: true    # Shared across all pods (for signal server)
  internal:           # Created per project (pod1_internal, pod2_internal) - isolated
